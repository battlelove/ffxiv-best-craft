{"version":3,"file":"Simulator-BGRlPmYY.js","sources":["../../src/components/designer/Simulator.vue"],"sourcesContent":["<!-- \n    This file is part of BestCraft.\n    Copyright (C) 2024  Tnze\n\n    BestCraft is free software: you can redistribute it and/or modify\n    it under the terms of the GNU Affero General Public License as published\n    by the Free Software Foundation, either version 3 of the License, or\n    (at your option) any later version.\n\n    BestCraft is distributed in the hope that it will be useful,\n    but WITHOUT ANY WARRANTY; without even the implied warranty of\n    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n    GNU Affero General Public License for more details.\n\n    You should have received a copy of the GNU Affero General Public License\n    along with this program.  If not, see <https://www.gnu.org/licenses/>.\n-->\n\n<script setup lang=\"ts\">\nimport {\n    ElScrollbar,\n    ElDialog,\n    ElButton,\n    ElTable,\n    ElTableColumn,\n    ElCard,\n    ElSwitch,\n} from 'element-plus';\nimport { Ref, computed, inject, ref, watch } from 'vue';\nimport {\n    Recipe,\n    Item,\n    Attributes,\n    Jobs,\n    newStatus,\n    Status,\n    Actions,\n    Conditions,\n    simulateOneStep,\n    CollectablesShopRefine,\n} from '@/libs/Craft';\nimport { Enhancer } from '@/libs/Enhancer';\nimport StatusBarVue from './StatusBar.vue';\nimport ActionPanelVue from './ActionPanel.vue';\nimport ActionQueueVue from './ActionQueue.vue';\nimport AttrEnhSelector from './tabs/AttrEnhSelector.vue';\nimport { displayJobKey } from './injectionkeys';\n\nconst props = defineProps<{\n    recipe: Recipe;\n    item: Item;\n    attributes: Attributes;\n    collectableShopRefine?: CollectablesShopRefine;\n}>();\nconst displayJob = inject(displayJobKey) as Ref<Jobs>;\n\ninterface Slot {\n    id: number;\n    action: Actions;\n    condition: Conditions;\n}\n\nconst attributesEnhancers = ref<Enhancer[]>([]);\nconst enhancedAttributes = computed<Attributes>(() => {\n    let { level, craftsmanship, control, craft_points } = props.attributes;\n    const sum = (prev: number, curr: number) => prev + curr;\n    craftsmanship += attributesEnhancers.value\n        .filter(v => v.cm && v.cm_max)\n        .map(v => Math.min((craftsmanship * v.cm!) / 100, v.cm_max!))\n        .reduce(sum, 0);\n    control += attributesEnhancers.value\n        .filter(v => v.ct && v.ct_max)\n        .map(v => Math.min((control * v.ct!) / 100, v.ct_max!))\n        .reduce(sum, 0);\n    craft_points += attributesEnhancers.value\n        .filter(v => v.cp && v.cp_max)\n        .map(v => Math.min((craft_points * v.cp!) / 100, v.cp_max!))\n        .reduce(sum, 0);\n    return {\n        level,\n        craftsmanship,\n        control,\n        craft_points,\n    };\n});\nconst initStatus = ref<Status>({\n    ...(await newStatus(enhancedAttributes.value, props.recipe)),\n    quality: 0,\n});\nwatch([props, enhancedAttributes], async ([p, attr]) => {\n    initStatus.value = {\n        ...(await newStatus(attr, p.recipe)),\n        quality: 0,\n    };\n});\n\nconst currentStatus = ref<Status>(initStatus.value);\nconst seq = ref<Slot[]>([]);\nconst openAttrEnhSelector = ref(false);\nconst results = ref<Status[]>([]);\nconst waiting = ref(false);\nconst preview = ref<Status | null>(null);\nconst rapidMode = ref(true);\nlet timer: any;\n\nconst sleep = (t: number) => new Promise(resolve => setTimeout(resolve, t));\nasync function pushAction(action: Actions) {\n    if (waiting.value) return;\n    leaveAction();\n    try {\n        let wait;\n        waiting.value = true;\n        if (!rapidMode.value) {\n        }\n        wait = sleep(rapidMode.value ? 300 : 1500);\n        const { status, is_success } = await simulateOneStep(\n            currentStatus.value,\n            action,\n            false,\n        );\n        await wait;\n        currentStatus.value = status;\n        if (!is_success) {\n            action = <Actions>action.concat('_fail');\n        }\n        seq.value.push({\n            id: seq.value.length,\n            action,\n            condition: currentStatus.value.condition,\n        });\n        if (\n            status.progress >= status.recipe.difficulty ||\n            status.durability <= 0\n        ) {\n            await sleep(2500);\n            restart();\n        }\n    } catch (e: unknown) {\n        console.error(e);\n    } finally {\n        if (timer != null) clearTimeout(timer);\n        waiting.value = false;\n    }\n}\n\nfunction restart() {\n    results.value.push(currentStatus.value);\n    seq.value.splice(0);\n    currentStatus.value = initStatus.value;\n}\n\nfunction hoverAction(action: Actions) {\n    if (timer != null) clearTimeout(timer);\n    timer = setTimeout(() => {\n        simulateOneStep(currentStatus.value, action, true)\n            .then(\n                v =>\n                    (preview.value = {\n                        ...v.status,\n                        condition: Conditions.Normal,\n                    }),\n            )\n            .catch(_e => {});\n    }, 1000);\n}\n\nfunction leaveAction() {\n    if (timer != null) clearTimeout(timer);\n    preview.value = null;\n}\n</script>\n\n<template>\n    <div class=\"main-page\">\n        <el-dialog v-model=\"openAttrEnhSelector\" :title=\"$t('meal-and-potion')\">\n            <AttrEnhSelector v-model=\"attributesEnhancers\" />\n        </el-dialog>\n        <StatusBarVue\n            class=\"status-bar\"\n            :attributes=\"attributes\"\n            :enhancers=\"attributesEnhancers\"\n            :status=\"preview ?? currentStatus\"\n            :show-condition=\"true\"\n            :collectableShopRefine=\"collectableShopRefine\"\n            @click-attributes=\"openAttrEnhSelector = true\"\n        />\n        <el-scrollbar class=\"action-queue\">\n            <ActionQueueVue :job=\"displayJob\" :list=\"seq\" disabled no-hover />\n        </el-scrollbar>\n        <div class=\"actionpanel\">\n            <el-scrollbar class=\"action-panel\">\n                <ActionPanelVue\n                    @clicked-action=\"pushAction\"\n                    :disable=\"waiting\"\n                    :job=\"displayJob\"\n                    :status=\"currentStatus\"\n                    simulator-mode\n                    #lower\n                    @mousehover-action=\"hoverAction\"\n                    @mouseleave-action=\"leaveAction\"\n                />\n                <el-button class=\"drop\" @click=\"restart\" type=\"danger\">{{\n                    $t('restart')\n                }}</el-button>\n                <el-switch\n                    v-model=\"rapidMode\"\n                    inline-prompt\n                    active-text=\"高速模式\"\n                    inactive-text=\"真实体验\"\n                />\n            </el-scrollbar>\n            <el-card class=\"results\">\n                <el-scrollbar>\n                    <el-table :data=\"results\">\n                        <el-table-column prop=\"step\" :label=\"$t('steps')\" />\n                        <el-table-column\n                            prop=\"progress\"\n                            :label=\"$t('progress')\"\n                        />\n                        <el-table-column\n                            prop=\"quality\"\n                            :label=\"$t('quality')\"\n                        />\n                    </el-table>\n                </el-scrollbar>\n            </el-card>\n        </div>\n    </div>\n</template>\n\n<style scoped>\n.el-main {\n    background-color: transparent !important;\n}\n\n.main-page {\n    height: 100%;\n    display: flex;\n    flex-direction: column;\n}\n\n.actionpanel {\n    display: flex;\n    flex: auto;\n    overflow: hidden;\n}\n\n.action-queue {\n    height: calc(48px * 1.7);\n    margin: 5px 6px;\n    padding: 5px 0px 0px 0px;\n    border-top: 1px solid var(--el-border-color);\n    border-bottom: 1px solid var(--el-border-color);\n}\n\n.action-panel {\n    margin-bottom: 6px;\n    max-width: 50%;\n}\n\n.results {\n    flex: auto;\n    margin: 20px;\n}\n\n.drop {\n    margin: 10px;\n}\n\n.el-table {\n    --el-table-header-bg-color: transparent;\n    --el-table-tr-bg-color: transparent;\n}\n</style>\n\n<fluent locale=\"zh-CN\">\nmeal-and-potion = 食物 & 药水\nrestart = 倒\n</fluent>\n\n<fluent locale=\"zh-TW\">\nmeal-and-potion = 食物 & 藥水\nrestart = 倒\n</fluent>\n\n<fluent locale=\"en-US\">\nmeal-and-potion = Meal & Potions\nrestart = Restart\n</fluent>\n"],"names":["props","__props","displayJob","inject","displayJobKey","attributesEnhancers","ref","enhancedAttributes","computed","level","craftsmanship","control","craft_points","sum","prev","curr","v","initStatus","__temp","__restore","_withAsyncContext","newStatus","watch","p","attr","currentStatus","seq","openAttrEnhSelector","results","waiting","preview","rapidMode","timer","sleep","t","resolve","pushAction","action","leaveAction","wait","status","is_success","simulateOneStep","restart","e","hoverAction","Conditions","_e","_openBlock","_createElementBlock","_hoisted_1","_createVNode","_unref","ElDialog","$event","$t","AttrEnhSelector","StatusBarVue","ElScrollbar","ActionQueueVue","_createElementVNode","_hoisted_2","ActionPanelVue","ElButton","ElSwitch","ElCard","ElTable","ElTableColumn"],"mappings":"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"}