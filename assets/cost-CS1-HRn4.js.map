{"version":3,"file":"cost-CS1-HRn4.js","sources":["../../src/libs/Universalis.ts","../../src/stores/cost.ts"],"sourcesContent":["export interface CurrentlyShown {\n    lastUploadTime: number;\n    listings: Listing[];\n    recentHistory: History[];\n    currentAveragePrice: number;\n    currentAveragePriceNQ: number;\n    currentAveragePriceHQ: number;\n    regularSaleVelocity: number;\n    nqSaleVelocity: number;\n    hqSaleVelocity: number;\n    averagePrice: number;\n    averagePriceNQ: number;\n    averagePriceHQ: number;\n    minPrice: number;\n    minPriceNQ: number;\n    minPriceHQ: number;\n    maxPrice: number;\n    maxPriceNQ: number;\n    maxPriceHQ: number;\n    stackSizeHistogram: { [key: string]: number };\n    stackSizeHistogramNQ: { [key: string]: number };\n    stackSizeHistogramHQ: { [key: string]: number };\n    worldName?: string;\n    worldID?: number;\n    dcName?: string;\n    regionName?: string;\n}\n\nexport interface Listing {\n    lastReviewTime: number;\n    pricePerUnit: number;\n    quantity: number;\n    stainID: number;\n    worldName?: string;\n    worldID?: number;\n    creatorName?: string;\n    creatorID?: string;\n    hq: boolean;\n    isCrafted: boolean;\n    materia?: Materia[];\n    total: number;\n}\n\nexport interface Materia {\n    slotID: number;\n    materiaID: number;\n}\n\nexport interface History {\n    hq: boolean;\n    pricePerUnit: number;\n    quantity: number;\n    timestamp: number;\n    worldName?: string;\n    worldID?: number;\n    buyerName?: string;\n    total: number;\n}\n\nexport interface UniversalisHistory {\n    itemID: number;\n    worldID: number;\n    lastUploadTime: number;\n    entries: History[];\n    stackSizeHistogram: { [key: string]: number };\n    stackSizeHistogramNQ: { [key: string]: number };\n    stackSizeHistogramHQ: { [key: string]: number };\n    regularSaleVelocity: number;\n    nqSaleVelocity: number;\n    hqSaleVelocity: number;\n}\n\nconst BASE_URL = 'https://universalis.app/api/v2';\n\nexport class UniversalisClient {\n    /**\n     * Fetch current market data for items\n     * @param worldDcRegion World, Data Center, or Region (e.g., \"Chocobo\", \"Garuda\")\n     * @param itemIds List of Item IDs\n     */\n    static async getMarketData(\n        worldDcRegion: string,\n        itemIds: number[],\n    ): Promise<Map<number, CurrentlyShown>> {\n        if (itemIds.length === 0) return new Map();\n\n        // Max IDs per request is technically limited, but usually high enough.\n        // We'll chunk if necessary, but 100 items is usually fine.\n        const ids = itemIds.join(',');\n        const url = `${BASE_URL}/${worldDcRegion}/${ids}?listings=5&entries=0`;\n\n        try {\n            const response = await fetch(url);\n            if (!response.ok) {\n                throw new Error(`Universalis API error: ${response.statusText}`);\n            }\n            const data = await response.json();\n\n            const result = new Map<number, CurrentlyShown>();\n\n            if (itemIds.length === 1) {\n                // If single item, response is the object itself (if valid)\n                // Note: Universalis single item response structure\n                result.set(itemIds[0], data as CurrentlyShown);\n            } else {\n                // If multiple items, response has 'items' key or keys are itemIDs\n                // Universalis v2 returns: { itemID: Data, itemID2: Data } or { items: ... } for some endpoints\n                // For /{world}/{ids}, if ids has comma, it returns:\n                // { \"items\": { \"123\": {...}, \"456\": {...} }, \"unresolvedItems\": [...] }\n                if (data.items) {\n                    for (const id in data.items) {\n                        result.set(Number(id), data.items[id]);\n                    }\n                }\n            }\n            return result;\n        } catch (e) {\n            console.error('Failed to fetch Universalis data', e);\n            return new Map();\n        }\n    }\n\n    /**\n     * Fetch history data for items (last 7 days by default from API logic, though we might need 'entries' param)\n     */\n    static async getHistory(\n        worldDcRegion: string,\n        itemIds: number[],\n        entriesToReturn = 1000, // Universalis default might be less\n    ): Promise<Map<number, UniversalisHistory>> {\n        if (itemIds.length === 0) return new Map();\n        \n        const ids = itemIds.join(',');\n        // history endpoint: /api/v2/history/{worldDcRegion}/{itemIds}\n        const url = `${BASE_URL}/history/${worldDcRegion}/${ids}?entriesWithin=604800&entries=${entriesToReturn}`; \n        // 604800 = 7 days in seconds\n\n        try {\n            const response = await fetch(url);\n            if (!response.ok) {\n                throw new Error(`Universalis API history error: ${response.statusText}`);\n            }\n            const data = await response.json();\n\n            const result = new Map<number, UniversalisHistory>();\n\n            if (itemIds.length === 1) {\n               result.set(itemIds[0], data as UniversalisHistory);\n            } else {\n                 if (data.items) {\n                    for (const id in data.items) {\n                        result.set(Number(id), data.items[id]);\n                    }\n                }\n            }\n            return result;\n        } catch (e) {\n            console.error('Failed to fetch Universalis history', e);\n            return new Map();\n        }\n    }\n}\n","import { defineStore } from 'pinia';\nimport { UniversalisClient, CurrentlyShown, UniversalisHistory } from '@/libs/Universalis';\nimport { useStorage } from '@vueuse/core';\n\nexport interface ItemPriceInfo {\n    itemId: number;\n    updatedAt: number;\n\n    // Market Board Data\n    marketPriceNQ: number; // Lowest NQ\n    marketPriceHQ: number; // Lowest HQ\n    averagePriceNQ: number;\n    averagePriceHQ: number;\n\n    // User Preferences / Overrides\n    manualPrice?: number;\n    useHQ: boolean; // If true, use HQ price for calculation (unless manual is set)\n\n    // Derived\n    effectivePrice: number; // The price used for calculation (Manual | Min(HQ, NQ) | etc)\n\n    // Meta\n    isManual: boolean;\n}\n\nexport default defineStore('cost', {\n    state: () => ({\n        // Map ItemID -> PriceInfo\n        prices: new Map<number, ItemPriceInfo>(),\n\n        // Settings\n        selectedWorld: useStorage('bestcraft-cost-world', 'Chocobo'), // Default to data center\n\n        // Cache history for trend graphs: ItemID -> History\n        historyCache: new Map<number, UniversalisHistory>(),\n    }),\n\n    getters: {\n        getPrice: (state) => (itemId: number): number => {\n            const info = state.prices.get(itemId);\n            if (!info) return 0;\n            return info.effectivePrice;\n        },\n\n        getItemPriceInfo: (state) => (itemId: number): ItemPriceInfo | undefined => {\n            return state.prices.get(itemId);\n        }\n    },\n\n    actions: {\n        /**\n         * Update prices for a list of items from Universalis\n         */\n        async fetchPrices(itemIds: number[]) {\n            if (itemIds.length === 0) return;\n            // Filter out items we recently updated? (Optional, skip for now for \"Refresh\" button logic)\n\n            const results = await UniversalisClient.getMarketData(this.selectedWorld, itemIds);\n\n            const now = Date.now();\n\n            for (const [id, data] of results.entries()) {\n                const existing = this.prices.get(id);\n\n                // Determine lowest prices\n                // Sometimes minPriceNQ/HQ might be 0 if no listings, fallback to average or other stats?\n                // For now, trust the API.\n\n                const minNQ = data.minPriceNQ || 0;\n                const minHQ = data.minPriceHQ || 0;\n\n                const newVal: ItemPriceInfo = {\n                    itemId: id,\n                    updatedAt: now,\n                    marketPriceNQ: minNQ,\n                    marketPriceHQ: minHQ,\n                    averagePriceNQ: data.averagePriceNQ || 0,\n                    averagePriceHQ: data.averagePriceHQ || 0,\n\n                    manualPrice: existing?.manualPrice,\n                    useHQ: existing?.useHQ ?? false,\n                    isManual: existing?.isManual ?? false,\n\n                    effectivePrice: 0 // Recalculate below\n                };\n\n                this.updateEffectivePrice(newVal);\n                this.prices.set(id, newVal);\n            }\n        },\n\n        /**\n         * Update price history\n         */\n        async fetchHistory(itemIds: number[]) {\n            const results = await UniversalisClient.getHistory(this.selectedWorld, itemIds);\n            for (const [id, data] of results.entries()) {\n                this.historyCache.set(id, data);\n            }\n        },\n\n        updateEffectivePrice(info: ItemPriceInfo) {\n            if (info.isManual && info.manualPrice !== undefined) {\n                info.effectivePrice = info.manualPrice;\n                return;\n            }\n\n            // If explicit HQ required\n            if (info.useHQ) {\n                // If HQ price exists, use it. Else fallback to NQ? Or considered infinite/unavailable?\n                // Let's assume if HQ is 0 (no listing), user might want to know. \n                // But for calculation safety, maybe fallback to NQ usually happens in game if no HQ? \n                // Actually usually you just buy NQ if no HQ, or you MUST have HQ.\n                // Simplification logic: Use HQ price.\n                info.effectivePrice = info.marketPriceHQ;\n            } else {\n                // Determine logic for \"Low Quality allowed\"\n                // Usually take the minimum of NQ and HQ (sometimes HQ is cheaper!)\n                // If minPriceNQ is 0 (no stock), try HQ.\n                const pNQ = info.marketPriceNQ;\n                const pHQ = info.marketPriceHQ;\n\n                if (pNQ > 0 && pHQ > 0) {\n                    info.effectivePrice = Math.min(pNQ, pHQ);\n                } else if (pNQ > 0) {\n                    info.effectivePrice = pNQ;\n                } else {\n                    info.effectivePrice = pHQ;\n                }\n            }\n        },\n\n        setManualPrice(itemId: number, price: number) {\n            let info = this.prices.get(itemId);\n            if (!info) {\n                // Create dummy info if not fetched yet\n                info = {\n                    itemId,\n                    updatedAt: Date.now(),\n                    marketPriceNQ: 0,\n                    marketPriceHQ: 0,\n                    averagePriceNQ: 0,\n                    averagePriceHQ: 0,\n                    useHQ: false,\n                    manualPrice: price,\n                    isManual: true,\n                    effectivePrice: price\n                };\n                this.prices.set(itemId, info);\n                return;\n            }\n\n            info.manualPrice = price;\n            info.isManual = true;\n            this.updateEffectivePrice(info);\n        },\n\n        clearManualPrice(itemId: number) {\n            const info = this.prices.get(itemId);\n            if (info) {\n                info.isManual = false;\n                info.manualPrice = undefined;\n                this.updateEffectivePrice(info);\n            }\n        },\n\n        setUseHQ(itemId: number, useHQ: boolean) {\n            const info = this.prices.get(itemId);\n            if (info) {\n                info.useHQ = useHQ;\n                this.updateEffectivePrice(info);\n            }\n        },\n\n        setWorld(world: string) {\n            this.selectedWorld = world;\n            // Maybe clear cache or trigger re-fetch?\n            // For now, just set. User should click \"Refresh\".\n        }\n    }\n});\n"],"names":["BASE_URL","UniversalisClient","worldDcRegion","itemIds","ids","url","response","data","result","id","e","entriesToReturn","useCostStore","defineStore","useStorage","state","itemId","info","results","now","existing","minNQ","minHQ","newVal","pNQ","pHQ","price","useHQ","world"],"mappings":"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"}