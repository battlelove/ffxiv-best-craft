{"version":3,"file":"ItemSelector-CNwNjixE.js","sources":["../../src/components/ItemSelector.vue"],"sourcesContent":["<template>\n    <el-dialog\n        v-model=\"visible\"\n        :title=\"title || $t('select-recipe')\"\n        width=\"800px\"\n        append-to-body\n        @closed=\"handleClose\"\n    >\n        <div class=\"search-bar\">\n            <el-input\n                v-model=\"searchQuery\"\n                :placeholder=\"$t('search-item-placeholder')\"\n                style=\"width: 300px; margin-right: 10px\"\n                @keyup.enter=\"handleSearch\"\n                clearable\n            />\n            <el-button type=\"primary\" @click=\"handleSearch\" :loading=\"loading\">{{ $t('search') }}</el-button>\n        </div>\n\n        <el-table\n            :data=\"results\"\n            style=\"width: 100%; margin-top: 20px\"\n            height=\"400\"\n            v-tnze-loading=\"loading\"\n            @row-click=\"handleSelect\"\n            stripe\n            highlight-current-row\n        >\n            <el-table-column prop=\"icon\" width=\"60\">\n                <template #default=\"scope\">\n                    <!-- Placeholder for icon if available, or just use a generic one -->\n                    <!-- We might need image URL logic later. For now, empty or generic -->\n                    <el-icon><Goods /></el-icon>\n                </template>\n            </el-table-column>\n            <el-table-column prop=\"name\" :label=\"$t('item-name')\" />\n            <el-table-column prop=\"item_id\" label=\"ID\" width=\"100\" v-if=\"mode !== 'item'\" />\n            <el-table-column prop=\"id\" label=\"ID\" width=\"100\" v-else />\n            \n            <el-table-column prop=\"job\" :label=\"$t('job')\" width=\"100\" v-if=\"mode !== 'item'\">\n                <template #default=\"scope\">\n                    {{ scope.row.job_code || scope.row.job_name || '-' }}\n                </template>   \n            </el-table-column>\n             <el-table-column prop=\"rlv\" :label=\"$t('level')\" width=\"80\" v-if=\"mode !== 'item'\" />\n             <el-table-column prop=\"level\" :label=\"$t('level')\" width=\"80\" v-else />\n        </el-table>\n\n        <div class=\"pagination-container\">\n             <el-pagination\n                v-if=\"results.length > 0\"\n                layout=\"prev, pager, next\"\n                :total=\"total\"\n                :page-size=\"pageSize\"\n                v-model:current-page=\"currentPage\"\n                @current-change=\"handlePageChange\"\n            />\n        </div>\n    </el-dialog>\n</template>\n\n<script setup lang=\"ts\">\nimport { ref, watch } from 'vue';\nimport { \n    ElDialog, \n    ElInput, \n    ElButton, \n    ElTable, \n    ElTableColumn, \n    ElIcon,\n    ElPagination,\n    ElMessage\n} from 'element-plus';\nimport { Goods } from '@element-plus/icons-vue';\nimport { useFluent } from 'fluent-vue';\nimport useSettingsStore from '@/stores/settings';\n\nconst { $t } = useFluent();\nconst settingsStore = useSettingsStore();\n\ninterface ItemSelectorProps {\n    modelValue: boolean;\n    initialQuery?: string;\n    title?: string;\n    mode?: 'recipe' | 'item'; \n    customSearch?: (page: number, query: string) => Promise<{ results: any[], totalPages: number }>;\n}\n\nconst props = defineProps<ItemSelectorProps>();\n\nconst emit = defineEmits<{\n    (e: 'update:modelValue', value: boolean): void;\n    (e: 'select', item: { id: number; name: string; recipeId: number }): void;\n}>();\n\nconst visible = ref(false);\nconst searchQuery = ref('');\nconst loading = ref(false);\nconst results = ref<any[]>([]);\nconst total = ref(0);\nconst pageSize = 10;\nconst currentPage = ref(1);\n\n// Sync modelValue with visible\nwatch(() => props.modelValue, (val) => {\n    visible.value = val;\n    if (val) {\n        if (props.initialQuery && props.initialQuery !== searchQuery.value) {\n            searchQuery.value = props.initialQuery;\n            // Immediate search if we have an initial query\n            handleSearch();\n        } else {\n             // If no initial query, maybe just load default/empty results?\n             // User wants \"sync\", so maybe load page 1 immediately?\n             if (!results.value.length) handleSearch();\n        }\n    }\n});\n\nwatch(visible, (val) => {\n    emit('update:modelValue', val);\n});\n\n// Live Search with Debounce\nlet debounceTimer: ReturnType<typeof setTimeout> | null = null;\nwatch(searchQuery, () => {\n    if (debounceTimer) clearTimeout(debounceTimer);\n    loading.value = true; // Show loading state early for feedback\n    debounceTimer = setTimeout(() => {\n        handleSearch();\n    }, 500); // 500ms delay to avoid API spam\n});\n\nasync function handleSearch() {\n    // if (!searchQuery.value) return; // Allow empty search to show default/all items\n    currentPage.value = 1;\n    await fetchResults();\n}\n\nasync function handlePageChange(page: number) {\n    currentPage.value = page;\n    await fetchResults();\n}\n\nasync function fetchResults() {\n    loading.value = true;\n    try {\n        if (props.customSearch) {\n             const res = await props.customSearch(currentPage.value, searchQuery.value);\n             results.value = res.results;\n             // Ensure totalPages is valid number\n             const pts = res.totalPages || 1;\n             total.value = pts * 10;\n        } else {\n            const ds = await settingsStore.getDataSource();\n            const res = await ds.recipeTable(currentPage.value, searchQuery.value);\n            results.value = res.results.map(r => ({\n                ...r,\n                name: r.item_name, \n            }));\n            const pts = res.totalPages || 1;\n            total.value = pts * 10; \n        }\n    } catch (e) {\n        ElMessage.error($t('search-error') + ': ' + String(e));\n    } finally {\n        loading.value = false;\n    }\n}\n\nfunction handleSelect(row: any) {\n    if (props.mode === 'item') {\n        // Row is Item: { id, name, ... }\n        emit('select', { id: row.id, name: row.name, recipeId: 0 });\n    } else {\n        // Row is Recipe: { id, item_id, item_name ... }\n        emit('select', { id: row.item_id, name: row.name, recipeId: row.id });\n    }\n    visible.value = false;\n}\n\nfunction handleClose() {\n    // Clear results?\n    // results.value = [];\n}\n</script>\n\n<style scoped>\n.search-bar {\n    display: flex;\n    justify-content: center;\n    margin-bottom: 10px;\n}\n.pagination-container {\n    display: flex;\n    justify-content: center;\n    margin-top: 15px;\n}\n</style>\n\n<fluent locale=\"zh-CN\">\nselect-recipe = 选择配方\nsearch-item-placeholder = 搜索物品名称...\nsearch = 搜索\nitem-name = 物品名称\njob = 职业\nlevel = 等级\nsearch-error = 搜索失败\n</fluent>\n\n<fluent locale=\"zh-TW\">\nselect-recipe = 選擇配方\nsearch-item-placeholder = 搜尋物品名稱...\nsearch = 搜尋\nitem-name = 物品名稱\njob = 職業\nlevel = 等級\nsearch-error = 搜尋失敗\n</fluent>\n\n<fluent locale=\"en-US\">\nselect-recipe = Select Recipe\nsearch-item-placeholder = Search item name...\nsearch = Search\nitem-name = Item Name\njob = Job\nlevel = Level\nsearch-error = Search failed\n</fluent>\n\n<fluent locale=\"ja-JP\">\nselect-recipe = レシピを選択\nsearch-item-placeholder = アイテム名を検索...\nsearch = 検索\nitem-name = アイテム名\njob = クラス\nlevel = レベル\nsearch-error = 検索失敗\n</fluent>\n"],"names":["pageSize","$t","useFluent","settingsStore","useSettingsStore","props","__props","emit","__emit","visible","ref","searchQuery","loading","results","total","currentPage","watch","val","handleSearch","debounceTimer","fetchResults","handlePageChange","page","res","pts","r","e","ElMessage","handleSelect","row","handleClose","_createBlock","_unref","ElDialog","$event","_createElementVNode","_hoisted_1","_createVNode","ElInput","ElButton","ElTable","ElTableColumn","_withCtx","scope","ElIcon","Goods","_hoisted_2","ElPagination"],"mappings":"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"}