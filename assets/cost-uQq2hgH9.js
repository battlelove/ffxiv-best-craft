import{ao as P,bE as h}from"./_plugin-vue_export-helper-BFa5o2E7.js";const f="https://universalis.app/api/v2";class u{static async getMarketData(r,t){if(t.length===0)return new Map;const c=t.join(","),o=`${f}/${r}/${c}?listings=5&entries=0`;try{const i=await fetch(o);if(!i.ok)throw new Error(`Universalis API error: ${i.statusText}`);const s=await i.json(),a=new Map;if(t.length===1)a.set(t[0],s);else if(s.items)for(const n in s.items)a.set(Number(n),s.items[n]);return a}catch(i){return console.error("Failed to fetch Universalis data",i),new Map}}static async getHistory(r,t,c=1e3){if(t.length===0)return new Map;const o=t.join(","),i=`${f}/history/${r}/${o}?entriesWithin=604800&entries=${c}`;try{const s=await fetch(i);if(!s.ok)throw new Error(`Universalis API history error: ${s.statusText}`);const a=await s.json(),n=new Map;if(t.length===1)n.set(t[0],a);else if(a.items)for(const l in a.items)n.set(Number(l),a.items[l]);return n}catch(s){return console.error("Failed to fetch Universalis history",s),new Map}}}const v=P("cost",{state:()=>({prices:new Map,selectedWorld:h("bestcraft-cost-world","Chocobo"),historyCache:new Map}),getters:{getPrice:e=>r=>{const t=e.prices.get(r);return t?t.effectivePrice:0},getItemPriceInfo:e=>r=>e.prices.get(r)},actions:{async fetchPrices(e){if(e.length===0)return;const r=await u.getMarketData(this.selectedWorld,e),t=Date.now();for(const[c,o]of r.entries()){const i=this.prices.get(c),s=o.minPriceNQ||0,a=o.minPriceHQ||0,n={itemId:c,updatedAt:t,marketPriceNQ:s,marketPriceHQ:a,averagePriceNQ:o.averagePriceNQ||0,averagePriceHQ:o.averagePriceHQ||0,manualPrice:i?.manualPrice,useHQ:i?.useHQ??!1,isManual:i?.isManual??!1,effectivePrice:0};this.updateEffectivePrice(n),this.prices.set(c,n)}},async fetchHistory(e){const r=await u.getHistory(this.selectedWorld,e);for(const[t,c]of r.entries())this.historyCache.set(t,c)},updateEffectivePrice(e){if(e.isManual&&e.manualPrice!==void 0){e.effectivePrice=e.manualPrice;return}if(e.useHQ)e.effectivePrice=e.marketPriceHQ;else{const r=e.marketPriceNQ,t=e.marketPriceHQ;r>0&&t>0?e.effectivePrice=Math.min(r,t):r>0?e.effectivePrice=r:e.effectivePrice=t}},setManualPrice(e,r){let t=this.prices.get(e);if(!t){t={itemId:e,updatedAt:Date.now(),marketPriceNQ:0,marketPriceHQ:0,averagePriceNQ:0,averagePriceHQ:0,useHQ:!1,manualPrice:r,isManual:!0,effectivePrice:r},this.prices.set(e,t);return}t.manualPrice=r,t.isManual=!0,this.updateEffectivePrice(t)},clearManualPrice(e){const r=this.prices.get(e);r&&(r.isManual=!1,r.manualPrice=void 0,this.updateEffectivePrice(r))},setUseHQ(e,r){const t=this.prices.get(e);t&&(t.useHQ=r,this.updateEffectivePrice(t))},setWorld(e){this.selectedWorld=e}}});export{v as u};
//# sourceMappingURL=cost-uQq2hgH9.js.map
