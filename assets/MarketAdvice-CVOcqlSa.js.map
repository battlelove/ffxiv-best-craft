{"version":3,"file":"MarketAdvice-CVOcqlSa.js","sources":["../../src/components/designer/MarketAdvice.vue"],"sourcesContent":["<template>\n    <div class=\"market-advice\" v-if=\"visible\">\n        <el-alert\n            v-if=\"loading\"\n            :title=\"$t('checking-prices')\"\n            type=\"info\"\n            show-icon\n            :closable=\"false\"\n        />\n        <el-alert\n            v-else-if=\"error\"\n            :title=\"$t('price-check-failed')\"\n            type=\"warning\"\n            show-icon\n            @close=\"visible = false\"\n        />\n        <el-alert\n            v-else\n            :title=\"adviceTitle\"\n            :type=\"adviceType\"\n            show-icon\n            :closable=\"true\"\n            @close=\"visible = false\"\n        >\n            <template #default>\n                <div class=\"advice-content\">\n                    <span>\n                        {{ $t('market-price') }}: <b>{{ formatGil(marketPrice) }}</b>\n                    </span>\n                    <el-divider direction=\"vertical\" />\n                    <span>\n                        {{ $t('crafting-cost') }}: <b>{{ formatGil(craftingCost) }}</b>\n                    </span>\n                    <el-divider direction=\"vertical\" />\n                    <span>\n                        {{ $t('profit') }}: <b>{{ formatGil(profit) }}</b>\n                    </span>\n                    <el-button link type=\"primary\" size=\"small\" @click=\"openProfitCalculator\" style=\"margin-left: 10px\">\n                        {{ $t('details') }} &gt;\n                    </el-button>\n                </div>\n            </template>\n        </el-alert>\n    </div>\n</template>\n\n<script setup lang=\"ts\">\nimport { ref, onMounted, computed, watch } from 'vue';\nimport { useFluent } from 'fluent-vue';\nimport useSettingsStore from '@/stores/settings';\nimport useCostStore from '@/stores/cost';\nimport { useRouter } from 'vue-router';\n\nconst props = defineProps<{\n    itemId: number;\n    recipeId: number;\n}>();\n\nconst { $t } = useFluent();\nconst settingsStore = useSettingsStore();\nconst costStore = useCostStore();\nconst router = useRouter();\n\nconst visible = ref(true);\nconst loading = ref(true);\nconst error = ref(false);\n\nconst marketPrice = ref(0);\nconst craftingCost = ref(0);\n\nconst profit = computed(() => {\n    // Simple profit: Price - Cost (Tax?)\n    // User asked \"Buy or Craft\".\n    // If Cost < Price * 0.95 (Tax), then Craft.\n    // If Cost > Price, then Buy.\n    return (marketPrice.value * 0.95) - craftingCost.value;\n});\n\nconst adviceType = computed(() => {\n    if (profit.value > 0) return 'success'; // Crafting is good\n    return 'warning'; // Buying is better (Profit negative)\n});\n\nconst adviceTitle = computed(() => {\n    if (profit.value > 0) return $t('advice-craft');\n    return $t('advice-buy');\n});\n\nfunction formatGil(val: number) {\n    return Math.floor(val).toLocaleString();\n}\n\nfunction openProfitCalculator() {\n    // Navigate to Profit Calculator with query?\n    // Current Profit Page implementation uses internal state.\n    // I should update Profit Page to accept query param `itemId` if I want deep linking.\n    // But for now, let's just go there.\n    router.push({ path: '/profit' }); \n    // Ideally pass item name but I don't have it easily here without fetching itemInfo.\n    // Actually I can pass itemId if I update ProfitCalculator to handle it.\n}\n\nasync function check() {\n    loading.value = true;\n    error.value = false;\n    visible.value = true;\n    \n    try {\n        const ds = await settingsStore.getDataSource();\n        \n        // 1. Get Ingredients\n        const ingredients = await ds.recipesIngredients(props.recipeId);\n        \n        // 2. Prepare IDs: Product + Ingredients\n        const ids = [props.itemId, ...ingredients.map(i => i.ingredient_id)];\n        \n        // 3. Fetch Prices\n        await costStore.fetchPrices(ids);\n        \n        // 4. Calculate\n        // Product Price (Min of HQ/NQ? Usually comparing for personal use -> assume NQ unless specified. \n        // But for Profit -> assume Product HQ if possible?\n        // Let's use costStore logic.\n        \n        const productInfo = costStore.getItemPriceInfo(props.itemId);\n        marketPrice.value = productInfo?.effectivePrice || 0;\n        \n        // If effective price is 0 (no listings), maybe fallback to something?\n        // If 0, we can't accept \"Buy\", so \"Craft\" might be default or \"Unknown\".\n        \n        let cost = 0;\n        for (const ing of ingredients) {\n             const p = costStore.getPrice(ing.ingredient_id);\n             cost += p * ing.amount;\n        }\n        craftingCost.value = cost;\n        \n        if (marketPrice.value === 0 && cost === 0) {\n            // Failed to fetch or invalid\n            error.value = true;\n        }\n        \n    } catch (e) {\n        console.error(e);\n        error.value = true;\n    } finally {\n        loading.value = false;\n    }\n}\n\nwatch(() => props.recipeId, () => {\n    check();\n}, { immediate: true });\n\n</script>\n\n<style scoped>\n.market-advice {\n    margin: 10px 0;\n}\n.advice-content {\n    margin-top: 5px;\n    display: flex;\n    align-items: center;\n    gap: 10px;\n}\n</style>\n\n<fluent locale=\"zh-CN\">\nchecking-prices = 正在查询市场价格...\nprice-check-failed = 无法获取市场数据\nadvice-buy = 建议直接购买 (购买更便宜)\nadvice-craft = 建议制作 (制作更便宜)\nmarket-price = 市场价\ncrafting-cost = 成本\nprofit = 预计利润\ndetails = 详情\n</fluent>\n\n<fluent locale=\"zh-TW\">\nchecking-prices = 正在查詢市場價格...\nprice-check-failed = 無法獲取市場數據\nadvice-buy = 建議直接購買 (購買更便宜)\nadvice-craft = 建議製作 (製作更便宜)\nmarket-price = 市場價\ncrafting-cost = 成本\nprofit = 預計利潤\ndetails = 詳情\n</fluent>\n\n<fluent locale=\"en-US\">\nchecking-prices = Checking market prices...\nprice-check-failed = Failed to fetch market data\nadvice-buy = Suggest Buying (Cheaper to Buy)\nadvice-craft = Suggest Crafting (Cheaper to Craft)\nmarket-price = Market Price\ncrafting-cost = Cost\nprofit = Est. Profit\ndetails = Details\n</fluent>\n"],"names":["props","__props","$t","useFluent","settingsStore","useSettingsStore","costStore","useCostStore","router","useRouter","visible","ref","loading","error","marketPrice","craftingCost","profit","computed","adviceType","adviceTitle","formatGil","val","openProfitCalculator","check","ingredients","ids","i","productInfo","cost","ing","p","e","watch","_openBlock","_createElementBlock","_hoisted_1","_createBlock","_component_el_alert","_unref","_createElementVNode","_hoisted_2","_createTextVNode","_toDisplayString","_createVNode","_component_el_divider","_component_el_button"],"mappings":"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"}